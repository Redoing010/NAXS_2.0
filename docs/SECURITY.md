# 安全与合规指南

NAXS 3.0 面向研究与回测场景，但仍需满足数据合规、访问控制及审计要求。本文定义最小安全基线。

## 1. 访问控制

- **RBAC**：`viewer`、`pro`、`admin`、`partner` 四类角色，绑定到 API Gateway。
- **策略粒度**：精确到 REST 路由与 Function Calling 工具。`pro` 方可访问回测与因子接口，`viewer` 仅可读公共指标。
- **多租户**：请求需携带 `X-Tenant-Id`，后端按租户隔离数据源与缓存。

## 2. 认证与授权

- API Gateway 使用 OAuth2 Client Credentials（外部）或 API Key（内部服务）。
- 前端使用短期 JWT（15 分钟），刷新令牌受限于 IP/设备指纹。
- Command 执行必须校验幂等键（`Idempotency-Key`）与 TraceId。

## 3. 数据保护

- **静态存储**：Parquet/ClickHouse/Neo4j 均启用磁盘加密；S3/OSS 使用 SSE-S3 或 SSE-KMS。
- **传输**：全部 HTTPS/TLS 1.2+，内部服务使用 mTLS。
- **脱敏**：敏感字段（个人信息、黑名单证券）在日志与报告中脱敏或聚合展示。
- **最小化**：仅保留研究所需数据，定期审查无关字段。

## 4. 日志与审计

- 所有请求记录 `trace_id`、`user_id`、`intent`、`command`、`parameters_hash`。
- 回测、报告生成保留数据快照指针（Parquet 分区、模型版本）。
- Audit 日志写入不可变存储（WORM/S3 版本化），保留 ≥ 2 年。

## 5. 安全测试

| 类型 | 描述 | 频率 |
| --- | --- | --- |
| 静态扫描 | ESLint/Pylint/Bandit/Snyk | 每次 CI |
| 依赖审计 | `npm audit`, `pip-audit` | 每周 |
| 渗透测试 | 外部或第三方工具 | 每半年 |
| 恢复演练 | 模拟数据泄露/回滚 | 每季度 |

## 6. 事件响应

1. 监测到安全告警后 15 分钟内 Oncall 响应。
2. 评估影响范围，隔离受影响服务（关闭 API 或切只读模式）。
3. 启动审计：导出相关 `trace_id` 与数据快照。
4. 在 24 小时内输出初步报告，48 小时内提交整改方案。

## 7. 合规要点

- 数据源授权协议存档，记录使用范围与保密条款。
- 开发/测试环境禁止使用真实敏感数据，需用脱敏样本。
- 研究报告需附带“仅供研究参考”声明。
- 遵循《数据安全法》、《个人信息保护法》等相关法规。

## 8. 变更管理

- 所有安全相关配置变更需提交 PR，并在上线前通过双人复核。
- 重大变更（认证方式、权限模型）需发布 RFC 并征求相关方意见。

> 若发现漏洞或合规问题，请邮件 security@naxs.local，并在 issue tracker 中创建 `SECURITY` 类型工单，确保跟踪与整改。
